<!DOCTYPE html>
<meta charset="utf-8">
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<title>Ecoengine Explorer</title>
<style>
body {
  font-family: "Lato", "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 12px;
  width: 100%;
  height: 100%;
  background: #fff;
  margin: 0;
  min-width: 960px;
}

a {
  color: #317eac;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

#map {
  margin: 38px 0 0 0;
  position: relative;
}

.wrap {
  margin: 8px 0 0 8px;
}

.header {
  color: #fff;
  background: #317eac;
  border-bottom: 1px solid #114e7c;
  padding: 8px;
  position: fixed;
  top: 0;
  height: 38px;
  width: 100%;
  z-index: 2000;
  overflow: hidden;
}

.header a {
  color: #fff;
  text-decoration: none;
}

.header a:hover {
  text-decoration: underline;
}

h2.app-title {
  margin: 0 12px 0 0;
  display: inline-block;
  font-size: 18px;
  font-weight: bold;
}

.header .eco-param {
  text-align: center;
}

.eco-param,
.eco-param2 {
  line-height: 15px;
  height: 22px;
  font-weight: bold;
  padding: 2px;
  color: #303030;
  border: 1px solid #666;
  border-radius: 2px;
}

#searchterm { 
  width: 120px;
}

.eco-param::-webkit-input-placeholder,
.eco-param::-webkit-input-placeholder { /* WebKit browsers */
  color:    #bbb;
  font-weight: normal;
  font-size: 13px;
}
.eco-param:-moz-placeholder,
.eco-param2:-moz-placeholder { /* Mozilla Firefox 4 to 18 */
  color:    #bbb;
  font-weight: normal;
  font-size: 13px;
  opacity:  1;
}
.eco-param::-moz-placeholder,
.eco-param2::-moz-placeholder { /* Mozilla Firefox 19+ */
  color:    #bbb;
  font-size: 13px;
  font-weight: normal;
  opacity:  1;
}
.eco-param:-ms-input-placeholder,
.eco-param2:-ms-input-placeholder { /* Internet Explorer 10+ */
  color:    #bbb;
  font-weight: normal;
  font-size: 13px;
}

h4 {
  font-size: 16px;
  font-weight: bold;
  margin: 12px 0 0;
}

.search-btn {
  background: #317eac;
  color: #fff;
  font-weight: bold;
  padding: 2px 6px;
  border-radius: 3px;
  cursor: pointer;
  display: inline-block;
}

.header .search-btn {
  color: #317eac;
  background: #fff;
}

.flydown h4 {
  margin-bottom: 8px;
}

.hide-btn {
  font-weight: bold;
  font-size: 15px;
  position: fixed;
  top: 46px;
  right: 24px;
}

#minyear,
#maxyear {
  width: 90px;
  text-align: center;
}

.export-buttons {
}

.flydown {
  background: #fff;
  border-bottom: 1px solid #114e7c;
  position: fixed;
  top: 0; 
  bottom: 0;
  height: 100%; 
  width: 100%;
  z-index:2000;
  padding: 8px;
  overflow: auto;
  display: none;
  margin-top: 38px;
}

.flydown .field td {
  padding: 4px 8px;
}


/* Time Slider */
svg {
  font-size: 8px;
  fill: #fff;
}

.axis path,
.axis line {
  fill: none;
  stroke: #abd;
}

.brush .extent {
  stroke: none;
  fill: #fff;
  fill-opacity: .5;
  shape-rendering: crispEdges;
}

#time-slider {
  display: inline;
}

#time-slider svg {
  margin-bottom: -12px;
}


.paging {
  margin: 8px 4px;
}

.pagination {
  margin: 0;
}

.pagination span {
  margin-right: 7px;
  cursor: pointer;
  padding: 1px 3px;
  color: #317eac;
}
.pagination span:hover {
  text-decoration: underline;
}
.pagination span.active {
  background: #317eac;
  color: #fff;
  border-radius: 3px;
  padding: 1px 6px;
  cursor: default;
}

.panel {
  background: transparent;
  border: none;
  position: relative;
  padding: 0;
  vertical-align: top;
  margin: 0;
}
.panel.left {
  width: 30%;
  float: left;
}
.panel.right {
  margin-left: 30%;
}
.panel:last-child {
  margin-right: 0;
}

/* MAP */
.map-detail {
  height: 360px;
  line-height: 1.3em;
}

.map-detail.left {
  padding: 8px 0 0 8px;
  overflow-y: auto;
  overflow-x: hidden;
}

#loading-view {
  margin-top: 8px;
}
#detail-view {
  margin-top: 8px;
}

#loading-view span {
  padding-left: 8px;
}
#loading-view span.loaded {
  color: #0a0;
}

#detail-view img {
  max-width: 260px;
  max-height: 220px;
  margin-bottom: 8px;
}

#map {
  width: 100%;
  height: 360px;
}

.leaflet-popup-pane {
  pointer-events: none;
}

.layer-selection {
  position: absolute;
  top: 10px;
  right: 10px;
  text-align: right;
  z-index: 100;
  width: 100%;
}

#bbox-select {
  position: absolute;
  bottom: 20px;
  right: 0px;
  text-align: right;
  z-index: 100;
  background: #fff;
  padding: 2px 12px;
  background: rgba(255,255,255,0.8);
  cursor: pointer;
}

.map-info {
  position: absolute;
  display: none;
  top: 0;
  right: 0;
  width: 90%;
  height: auto;
  background: #fff;
  background: rgba(255,255,255,0.8);
  z-index: 1001;
}
.map-info.visible {
  display: block;
}

.map-info-close {
  position: absolute;
  top: 1px;
  right: 5px;
  padding: 0;
  background: transparent;
  border: none;
  outline: none;
  font-weight: normal;
  font-size: 10px;
  text-transform: uppercase;
  color: #aaa;
  cursor: pointer;
}

.map-info-content {
  padding: 10px 30px 10px 10px;
  margin: 0;
  font-size: 12px;
  line-height: 18px;
  color: #333;
}

.eco-basic-icon {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #317eac;
  background: rgba(49,126,172,1);
  border: 1px solid #fff;
}

#detail-type .eco-basic-icon {
  display: inline-block;
  height: 16px;
  width: 16px;
  display: inline-block;
  position: relative;
  top: 2px;
}

.table .eco-basic-icon {
  display: inline-block;
  position: relative;
  margin-right: 4px;
  top: 2px;
}

.eco-basic-icon.sensor {
  border-radius: 0px;
  background: #d95f02;
}

.eco-basic-icon.vtm-vegetation-feature {
  background: #1b9e77;
}

.eco-basic-icon.plot-survey {
  background: #7570b3;
}

.eco-basic-icon.photo {
  background: #a6cee3;
}

.eco-basic-icon.media-photo {
  border-radius: 1px;
  background: #a6cee3;
}

.eco-basic-icon.specimen {
  background: #e6ab02;
}

.eco-basic-icon.fossil {
  background: #a7871d;
}

.eco-basic-icon.observation {
  background: #1f78b4;
}

.eco-basic-icon.checklist {
  background: #666666;
}


/*
.eco-basic-icon:before {
    content: ' ';
    position: absolute;
    top: 0;
    left: 0;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: rgba(0,0,0,0.2);
    margin-left: -3px;
    margin-top: -3px;
    z-index: 0;
}
*/

.eco-photo-icon {
    width: 10px;
    height: 10px;
    border-radius: 3px;
    background: rgba(255,0,0,0.3);
}

.blocker {
  position: absolute;
  height: 100%;
  width: 100%;
  background: rgba(255,255,255,0.8);
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 9999999;
  margin: 0;
  padding: 0;
  display: none;
}
.loading .blocker {
  display: block;
}


#photos {
  width: 100%;
  color: #fff;
  background: #111;
  min-height: 24px;
  padding: 1px;
}
#photos img {
  height: 64px;
  display: inline-block;
  padding: 1px;
}

#photos {
  position: relative;
}

#photos h4 {
  pointer-events: none;
  position: absolute;
  top: 4px;
  left: 8px;
  background: rgba(0,0,0,0.5);
}

#results table {
  font-size: 12px;
}

#results table td,
#results table th {
  padding: 2px 4px;
}
#results table th {
  border-bottom: 1px solid #d0d0d0;
}
.listing {
  border-bottom: 1px solid #f0f0f0;
}
.zebra {
  background: #fff;
}

table .active {
  background: #feb;
}

.bar:hover {
  background: #ee4e32;
  cursor: pointer;
}
.field-plot {
  line-height: 14px;
}
.field-plot span {
  text-decoration: none;
  padding-right: 4px;
}
.field-plot span {
  color: #222;
}
.field-plot .active {
  background: #feb;
  font-weight: bold;
}
.field-plot .x {
  display: none;
  color: #ee4e32;
  font-weight: bold;
}
.field-plot .active:hover .x {
  display: inline;
}
.field-plot .show-more {
  color: #bbb;
  cursor: pointer;
  font-size: 12px;
  line-height: 15px;
  display: block;
  width: 100%;
  text-align: center;
}
.field-plot .show-more:hover {
  color: #333;
}
.bar {
  display: inline-block;
  margin: 0 8px -1px;
  background: #317eac;
}
h3 {
  font-weight: bold;
  font-size: 1em;
  line-height: 1em;
  margin: 10px 0 4px 0;
}
.cursor {
  cursor: pointer;
}

</style>
<body>
<div class="header">
  Search <input type="text" value="" id="searchterm" class="eco-param" placeholder="Observations/photos"></input>
  &nbsp; Date Range <input type="text" value="" id="minyear" class="eco-param" placeholder="1900-01-01"></input>
  <span id="time-slider"></span>
  <input type="text" value="" id="maxyear" class="eco-param" placeholder="2018-12-31"></input>
  &nbsp; <div class="search-btn">Search</div>
  &nbsp; <span class="cursor" id="advanced-search-btn">Advanced</span> |
  <span class="cursor" id="export-btn">Export</span>
</div>
<div id="advanced-search" class="flydown">
  <h4>Advanced Search</h4>
  <p>
    <div style="display:none;">
      <strong>Footprint</strong><br/>
      <p>
      Footprint <select id="reserve-list">
        <option></option>
      </select><select id="jepson-list">
        <option></option>
      </select>
      </p>
    </div>
    <div id="advanced-search-pane"></div>
    <p>
      <div class="search-btn">Search</div>
    </p>
      
  </p>
  <a href="#" class="hide-btn">Hide</a>
</div>

<div id="export-pane" class="flydown">
  <h4>Export</h4> 
  <p>This flyout is intended to provide information about the queries and export options for each API.</p>
  <h4>Observations</h4>
  <p>
    <span class="export-buttons">
      CSV <a href="#" id="export-csv" target="_blank"></a><br/>
      JSON <a href="#" id="export-json" target="_blank"></a><br/>
      GeoJSON <a href="#" id="export-geojson" target="_blank"></a><br/>
    <span>
  </p>
  <h4>Search</h4>
      Data <a href="#" id="export-search" target="_blank"></a><br/>
  <h4>Photos</h4>
      Data <a href="#" id="export-photos" target="_blank"></a><br/>
  <h4>Sensors</h4>
      Data <a href="#" id="export-sensors" target="_blank"></a><br/>
  <h4>Raster Layers</h4>
      Layers <a href="#" id="export-layers" target="_blank"></a><br/>
      Rasters <a href="#" id="export-rasters" target="_blank"></a><br/>
  <h4>Footprints</h4>
      Jepsen Regions <a href="#" id="export-jepson" target="_blank"></a><br/>
      Reserves <a href="#" id="export-reserves" target="_blank"></a><br/>
  <a href="#" class="hide-btn">Hide</a>
</div>

<div class="panel left map-detail">
  <h4><span id="detail-type"></span> Details</h4>
  <p id="loading-view">
  </p>
  <p id="detail-view">
  </p>
</div>
<div class="panel right map-detail">
  <div id="map">
    <div class="layer-selection">
      <select id="overlay-select">
        <option value="https://dev-ecoengine.berkeley.edu/tiles/vtmveg/{z}/{x}/{y}.png">VTM Vegetation Features</option>
      </select>
      <select id="layer-select">
        <option value="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png">OpenStreetMap</option>
        <option value="http://{s}.tile.stamen.com/terrain-background/{z}/{x}/{y}.jpg">Stamen Terrain</option>
      </select>
    </div>
    <div id="bbox-select">
      Click to show only results on the map.
    </div>
  </div>
  <div class="map-info">
      <button class="map-info-close">x</button>
      <p class="map-info-content"></p>
  </div>
</div>
<div id="photos" class="photos">
  <h4>Photos</h4>
  <div class="inner-photos">
  </div>
</div>
<div class="wrap">
  <div class="panel left">
    <h4>Search Results</h4>
    <div id="search-bars"></div>
  </div>
  <div class="panel right">
    <h4>Observations</h4>
    <div id="results"></div>
  </div>
</div>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="../lib/hashnav.js"></script>
<script src="config.js"></script>
<script>
var fields = [
  "record",
  "scientific_name",
  "country",
  "state_province",
  "begin_date",
  "end_date",
  "geojson",
  "observation_type"
];

var queryObj = {
  page_size: 200,
  page: 1,
  facets: {
    kingdom: false,
    phylum: false,
    clss: false,
    order: false,
    family: false,
    genus: false,
    'scientific_name': false,
    'state_province': false,
    resource: false
  },
  bbox: "",
  sortFields: {},
  advanced: {},
  q: "",          
  min_date: "",
  max_date: ""
};

fields.forEach(function(d) { queryObj.sortFields[d] = false; });

function logHash(hash) {            
  console.log(hash);
  if (hash.parameters) {              
    var parameters = hash.parameters;
    for (var name in parameters) {
      var value = parameters[name];
      console.log(name,value);
      if (name == "q") {
        var fields = value.replace(/"/g, "").split(",")
        queryObj.q = fields[0];
        fields.slice(1).forEach(function(d) {
          var pair = d.split(":");
          queryObj.advanced[pair[0]] = pair[1];
        });
      } else if (name == "ordering") {
        var fields = value.split(",")
        fields.forEach(function(d) {
          var field = d.replace("-","");
          queryObj.sortFields[field] = d[0] == "-" ? "-" : "+";
        });
      } else if (name == "selected_facets") {
        var items = value.replace(/"/g, "").split(",")
        items.forEach(function(d) {
          var pair = d.split(":");
          queryObj.facets[pair[0].replace(/_exact/g, "")] = pair[1];
        });
      } else {
        queryObj[name] = value;
      }
    }
  } else {
    console.log("There are no parameters.");
    console.log(hash.raw);
  }       
}

initHashNav(logHash);

if (queryObj.q) {
  d3.select("#searchterm").node().value = queryObj.q;
}
if (queryObj.min_date) {
  d3.select("#minyear").node().value = queryObj.min_date; 
}
if (queryObj.max_date) {
  d3.select("#maxyear").node().value = queryObj.max_date;
}


var mapData = [];
var photoData = [];
var sensorData = [];

var ECO = ECO || {};
ECO.base = {
  api: {
    search: 'https://dev-ecoengine.berkeley.edu/api/search/',
    observations: 'https://dev-ecoengine.berkeley.edu/api/observations/',
    photos: 'https://dev-ecoengine.berkeley.edu/api/photos/',
    sensors: 'https://dev-ecoengine.berkeley.edu/api/sensors/?page_size=5000&format=geojson',
    layers: 'https://dev-ecoengine.berkeley.edu/api/layers/',
    rasters: '../tiles/rstore.json',
    reserves: 'https://dev-ecoengine.berkeley.edu/api/layers/reserves/features/?page_size=500',
    jepson: 'https://dev-ecoengine.berkeley.edu/api/layers/jepson-regions/features/?page_size=500'
  }
}

var sortOrder = {
  georeferenced: 1,
  country: 2,
  'state_province': 3,
  kingdom: 5,
  phylum: 7,
  clss: 9,
  order: 11,
  family: 13,
  genus: 15,
  'scientific_name': 17,
  'observation_type': 19
};

var dateformat = d3.time.format("%Y %b %e");
var compactdateformat = d3.time.format("%Y-%m-%d");


var loadingView = d3.select("#loading-view")
  .selectAll("div")
  .data(d3.keys(ECO.base.api))
  .enter().append("div");

loadingView.append("strong")
  .text(function(d) {
    return capitaliseFirstLetter(d);
  });

loadingView.append("span")
  .attr("class", String);

var advancedSearchSections = d3.select("#advanced-search-pane")
  .selectAll("div.section")
  .data(ECO.advancedSearch)
  .enter().append("div")
  .attr("class", "section");

advancedSearchSections.append("h3")
  .text(function(d) { return d.section; });

var table = advancedSearchSections
  .append("table")

var rows = table
  .selectAll("tr.field")
  .data(function(d) { return d.fields; })
  .enter().append("tr")
  .attr("class", "field");

rows.append("td")
  .text(function(d) { return capitaliseFirstLetter(d.field
          .replace(/_/g, " ")
          .replace("clss", "class")
        ); });

rows.append("td")
  .append("input")
  .attr("type", "text")
  .attr("class", "eco-param2")
  .attr("placeholder", function(d) {
    return "placeholder" in d ? d.placeholder : null;
  })
  .attr("value", function(d) {
    return d.field in queryObj.advanced ? queryObj.advanced[d.field] : null;
  })
  .on("change", function(d) {
    queryObj.advanced[d.field] = this.value;
  });

d3.selectAll(".search-btn").on("click", function() {
  query();
  hideflydowns();
});


d3.select("#advanced-search-btn").on("click", function() {
  if (d3.select("#advanced-search").style("display") == "block") {
    hideflydowns();
    return;
  }

  d3.selectAll(".flydown")
    .style("display", null)
    .style("opacity", 0);
  d3.select("#advanced-search")
    .style("display", "block")
    .transition()
    .style("height", (window.innerHeight-38) + "px")
    .style("opacity", 1);
});

d3.select("#export-btn").on("click", function() {
  if (d3.select("#export-pane").style("display") == "block") {
    hideflydowns();
    return;
  }

  d3.selectAll(".flydown")
    .style("display", null)
    .style("opacity", 0)
  d3.select("#export-pane")
    .style("display", "block")
    .transition()
    .style("height", (window.innerHeight-38) + "px")
    .style("opacity", 1);
});

d3.selectAll(".hide-btn").on("click", hideflydowns);

function hideflydowns() {
  d3.selectAll(".flydown")
    .transition()
    .duration(250)
    .style("opacity", 0)
    .style("height", "0px")
    .transition()
    .delay(250)
    .style("display", null)
};

d3.select("#export-sensors")
  .attr("href", ECO.base.api.sensors)
  .text(ECO.base.api.sensors);
d3.select("#loading-view .sensors")
  .classed("loaded", false)
  .text("Loading...");
d3.json(ECO.base.api.sensors, function(error, data) {
  d3.select("#loading-view .sensors")
    .classed("loaded", true)
    .text("Loaded");

  map.clear();
  sensorData = data.features;

  map.draw();
});

ECO.detailview = function(row) {
  var container = d3.select("#detail-view")
    .style("display", null)
    .html("");

  d3.select("#loading-view").style("display", "none");

  if ("media_url" in row && row.media_url) {
    container.append("a")
      .attr("href", row.media_url)
    .append("img")
      .attr("src", row.media_url);
  }

  var divs = container.selectAll("div")
    .data(d3.entries(row))
    .enter().append("div")

  divs.append("strong")
    .html(function(d) { return d.key + " &nbsp; "; });

  divs.append("span")
    .html(function(d) {

      if (typeof d.value == "string") {
        if (d.value.slice(0,4) == "http") {
          return "<a href='" + d.value + "'>" + d.value + "</a>";
        }
        return d.value;
      }
      return JSON.stringify(d.value);
    });
};

ECO.map = function() {
  var __ = {};

  var defaultCenter = new L.LatLng(37.7,-122),
      defaultZoom = 6,
      markers = [],
      subscribers = [],
      map;


  var popup = L.popup({
    closeButton: false,
    offset: new L.Point(0,-4)
  });

  map = __.map = L.map('map').setView(defaultCenter, defaultZoom);


  var baseLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '',
    subdomains: 'abc',
    minZoom: 1,
    transparent: true,
    maxZoom: 16
  }).addTo(map);

  var overlayLayer = L.tileLayer('https://dev-ecoengine.berkeley.edu/tiles/vtmveg/{z}/{x}/{y}.png', {
    attribution: '',
    subdomains: 'abc',
    minZoom: 2,
    transparent: true,
    maxZoom: 16
  }).addTo(map);


  d3.select("#export-layers")
    .attr("href", ECO.base.api.layers)
    .text(ECO.base.api.layers);
  d3.select("#export-rasters")
    .attr("href", ECO.base.api.rasters)
    .text(ECO.base.api.rasters);
  // Layer select box

  d3.select("#loading-view .layers")
    .classed("loaded", false)
    .text("Loading...");
  d3.json(ECO.base.api.layers, function(error, layers) {
    d3.select("#loading-view .layers")
      .classed("loaded", true)
      .text("Loaded");

    d3.select("#loading-view .rasters")
      .classed("loaded", false)
      .text("Loading...");
    d3.json(ECO.base.api.rasters, function(error, rasters) {
      if (!rasters) return;

      d3.select("#loading-view .rasters")
        .classed("loaded", true)
        .text("Loaded");
      rasters.results.forEach(function(d) {
        if (d.tags.indexOf("boundaries") > -1) { 
          d3.select("#overlay-select")
            .append("option")
            .attr("value", d.tile_template)
            .text(d.name);
        } else {
          d3.select("#layer-select")
            .append("option")
            .attr("value", d.tile_template)
            .text(d.name);
        }
      });
    });

    if (!layers) return;
    layers.results.forEach(function(d) {
        if (d.tags.indexOf("boundaries") > -1) { 
          d3.select("#overlay-select")
            .append("option")
            .attr("value", d.tile_template)
            .text(d.name);
        } else {
          d3.select("#layer-select")
            .append("option")
            .attr("value", d.tile_template)
            .text(d.name);
        }
    });
  });

  d3.select("#layer-select")
    .on("change", function() {
      baseLayer.setUrl(this.value);
    });
  d3.select("#overlay-select")
    .on("change", function() {
      overlayLayer.setUrl(this.value);
    });

  /*
  var apiLayer = L.tileLayer(ECO.base.api.tiles, {
    attribution: '&copy; <a href="http://ecoengine.berkeley.edu">EcoEngine</a>',
    subdomains: 'abc',
    minZoom: 1,
    maxZoom: 18
  }).addTo(map);
  */

  function clearMarkers() {
    markers.forEach(function(marker){
      marker.off('mouseover', onMarkerOver)
            .off('mouseout', onMarkerOut)
            .off('click', onMarkerClick);

      map.removeLayer(marker);
      marker = undefined;
    });

    markers.length = 0;
  }

  function onMarkerOver(evt) {
    showTooltip(evt);
    var type = '';
    if ('observation_type' in evt.target.data_) {
      type = 'Observation';
    } else if ('media_url' in evt.target.data_) {
      type = 'Photo';
    } else {
      type = 'Sensor';
    }

    if (type == 'Observation') {
      d3.select("#detail-type").html("<span class='eco-basic-icon " + evt.target.data_.observation_type + "'></span> Observation")
    }
    if (type == 'Photo') {
      d3.select("#detail-type").html("<span class='eco-basic-icon media-photo'></span> Photo")
    }
    if (type == 'Sensor') {
      d3.select("#detail-type").html("<span class='eco-basic-icon sensor'></span> Sensor")
    }
    ECO.detailview(evt.target.data_);
    subscribers.forEach(function(s){
      if (s.over) s.over(evt);
    });
  }

  function onMarkerOut(evt) {
    hideTooltip();
    showLoadingView();
    subscribers.forEach(function(s){
      if (s.out) s.out(evt);
    });
  }

  function onMarkerClick(evt) {
    evt.originalEvent.preventDefault();
    subscribers.forEach(function(s){
      if (s.click) s.click(evt);
    });
  }

  function addPoly(layer, color) {
    var poly = L.geoJson(layer.geometry, {
      style: {
        color: color,
        weight: 1,
        opacity: 0.9,
        fillOpacity: 0.8

      }
    }).addTo(map); 

    poly.on('mouseover', function() {
      d3.select("#detail-type").text("Reserve ");
      ECO.detailview(layer.properties);
    })
    .on("mouseout", function() {
      showLoadingView();
    });
  };

  function addMarkers(data) {
    //console.log('markers', data)
    var bds = null;

    data.forEach(function(d){
      var type = '';
      if ('observation_type' in d.properties) {
        type = 'observation';
      } else if ('media_url' in d.properties) {
        type = 'photo';
      } else {
        type = 'sensor';
      }      

      if (type == 'observation') {
        var markerIcon= L.divIcon({
          className: 'eco-basic-icon ' + d.properties.observation_type.replace(/ /g,"-"),
          iconSize: new L.Point(12,12)
        });
      }

      if (type == 'photo') {
        var markerIcon= L.divIcon({
          className: 'eco-basic-icon media-photo',
          iconSize: new L.Point(12,12)
        });
      }

      if (type == 'sensor') {
        var markerIcon= L.divIcon({
          className: 'eco-basic-icon sensor',
          iconSize: new L.Point(12,12)
        });
      }

      var ll = new L.LatLng(d.geometry.coordinates[1], d.geometry.coordinates[0])
      var m = L.marker(ll, {riseOnHover: true, icon: markerIcon}).addTo(map);
      m.data_ = d.properties;
      m.on('mouseover', onMarkerOver)
        .on('mouseout', onMarkerOut)
        .on('click', onMarkerClick);

      if (!bds) {
        bds = new L.latLngBounds([ll]);
      } else {
        bds.extend(ll);
      }
      markers.push(m);
    });

    bds.pad(0.1);

    setTimeout(function(){
      // basic method to determine if bounds is big enough to set
      var tr = map.latLngToLayerPoint(bds.getNorthEast()),
          bl = map.latLngToLayerPoint(bds.getSouthWest()),
          xDiff = Math.abs(tr.x - bl.x),
          yDiff = Math.abs(tr.y - bl.y);

      if (xDiff < 200 || yDiff < 200) {
        map.setView(bds.getCenter(), 5);
      } else {
        map.fitBounds(bds);
      }

    },1);
  }

  function showTooltip(evt) {
      if (!evt.target.data_) return;
      var type = ''
      if ('observation_type' in evt.target.data_) {
        type = 'Observation';
      } else if ('media_url' in evt.target.data_) {
        type = 'Photo';
      } else {
        type = 'Sensor';
      }

      if (type == 'Observation') {
        var content = "<strong>" + type + " (" + evt.target.data_.observation_type + ")</strong><br/>";
      } else {
        var content = "<strong>" + type + "</strong><br/>";
      }
      
      if (type == 'Observation') {
        content += evt.target.data_['scientific_name'] + "<br/>" + evt.target.data_['record'];
      }
      if (type == 'Photo') {
        content += evt.target.data_['authors'] + "<br/>" + evt.target.data_['record'];
      }
      if (type == 'Sensor') {
        content += evt.target.data_['station_name'] + "<br/>" + evt.target.data_['record'];
      }
      popup
          .setLatLng(evt.target._latlng)
          .setContent(content)
          .openOn(map);
  }

  function hideTooltip() {
      popup._close();
  }


  /**
   * Add listener objects for markers
   * @param  Object {over:fn, out: fn, click: fn}
   * @return subscribers Array || this
   */
  __.subscribe = function(_) {
    if (!_) return subscribers;
    subscribers.push(_);
    return __;
  }

  __.clear = clearMarkers;

  __.draw = function() {
    /*
    if (!data.length) {
      ECO.mapAlert.set('No map data available.');
      return;
    }
    */

    ECO.mapAlert.hide();

    if (mapData.length) addMarkers(mapData);
    if (sensorData.length) addMarkers(sensorData);
    if (photoData.length) addMarkers(photoData);
  }

  __.addPoly = addPoly;

  return __;
};

ECO.mapAlert = {
  rootElm: d3.select('.map-info'),
  contentElm: d3.select('.map-info-content'),
  closeElm: null,
  show: function(){
    if(this.rootElm.classed('visible')) return;
    this.rootElm.classed('visible', true);
  },
  hide: function() {
    this.rootElm.classed('visible', false);
  },
  set: function(str) {
    this.contentElm.text(str);
    if (!this.closeElm) {
      d3.select('.map-info-close').on('click',function(){
        ECO.mapAlert.hide();
      })
    }
    if (!this.rootElm.classed('visible')) this.show();
  }
};

ECO.list = function() {
  var __ = {};

  var barwidth = d3.scale.linear()
    .range([0, 100]);

  __.draw = function(data) {
    d3.selectAll(".field-plot a").style("color", null);

    // Total bar width
    var maxcount = 0;
    for (var key in data.fields) {
      var count = 0;
      data.fields[key].forEach(function(d) {
        count += d[1];
      });
      if (count > maxcount) maxcount = count;
    }
    barwidth.domain([0, maxcount]);

    var searchfields = d3.keys(data.fields);
    searchfields.sort(function(a,b){
      var one = a in sortOrder ? sortOrder[a] : 100;
      var two = b in sortOrder ? sortOrder[b] : 100;
      return one - two;
    });

    // Groups
    var fieldplot = d3.select("#search-bars")
      .html("")
      .selectAll("div.field-plot")
      .data(searchfields.map(function(key) { return {
        "field": key,
        "values": data.fields[key]
      }}))
      .enter().append("div")
      .attr("class", "field-plot");

    fieldplot.append("h3")
      .text(function(d) {
        return capitaliseFirstLetter(d.field
          .replace(/_/g, " ")
          .replace("clss", "class")
        )});

    var bars = fieldplot.selectAll("div.bars")
        .data(function(d) { return d.values; })
        .enter().append("div")
        .attr("class", "bars")
        .append("div")
        .style("display", function(d,i) { return i > 9 ? "none" : null})
        .classed("active", function(d,i,g) {
          return queryObj.facets[searchfields[g]] == d[0];
        })
        .on("mouseover", function(d,i,g) {
          d3.select("#detail-type").text("Search");
          ECO.detailview({
            "field": searchfields[g],
            "value": d[0],
            "count": d[1],
            "url": d[2]
          });
        })
        .on("mouseout", function() {
          showLoadingView();
        })
        .on("click", function(d,i,g) {
          queryObj.page = 1;
          if (queryObj.facets[searchfields[g]] == d[0]) {
            queryObj.facets[searchfields[g]] = false;
          } else {
            queryObj.facets[searchfields[g]] = d[0];
          }
          query();
        });

    bars.append("div")
      .attr("class", "bar")
      .style("height", "12px")
      .style("width", function(d) { return Math.round(barwidth(d[1])) + "px"; });

    bars.append("span")
      .attr("class", "count")
      .text(function(d) { return d[1]; });

    bars.append("span")
      .text(function(d) { return " " + capitaliseFirstLetter(d[0]); });

    bars.append("span")
      .attr("class", "x")
      .text(" x");

    fieldplot
      .filter(function(d) { return d.values.length > 9; })
      .append("span")
      .attr("class", "show-more")
      .text("[+] Show more")
      .on("click", function(d) {
        bars.filter(function(p,i,g) { 
          return searchfields[g] == d.field;
        })
        .style("display", "block");

        d3.select(this).remove();
      });
  }
  return __;
};

ECO.datatable = function() {
  var __ = {};

  __.mapEvents = {
      over: function(evt) {
        if (!evt.target.data_) return;
        var props = evt.target.data_;
        __.table.selectAll("tr.listing")
          .classed("active", function(d) {
            return props.record == d.properties.record;
          });
        console.log("Datatable: Marker mouseover: ", props.record);
      },
      out: function(evt) {
        if (!evt.target.data_) return;
        var props = evt.target.data_;
        __.table.selectAll("tr.listing")
          .classed("active", false);
        console.log("Datatable: Marker mouseout: ", props.record);
      },
      click: function(evt) {
        if (!evt.target.data_) return;
        var props = evt.target.data_;
        console.log("Datatable: Marker click: ", props.record);
      }
  };

  __.draw = function(data) {
    __.table = d3.select("#results")
      .append("table")
      .attr("class", "table");

    __.table.append("tr")
      .selectAll("th")
      .data(fields)
      .enter().append("th")
      .text(String)
      .style("color", function(d) {
        if (queryObj.sortFields[d] == "+") { 
          return "#0a0";
        }
        if (queryObj.sortFields[d] == "-") { 
          return "#b00";
        }
      })
      .on("click", function(d) {
        if (queryObj.sortFields[d] == false) { 
          queryObj.sortFields[d] = "+";
        } else if (queryObj.sortFields[d] == "+") { 
          queryObj.sortFields[d] = "-";
        } else if (queryObj.sortFields[d] == "-") { 
          queryObj.sortFields[d] = "+";
        }
        query();
      });

    __.table
      .selectAll("tr.listing")
      .data(data.features)
      .enter().append("tr")
      .attr("class", "listing")
      .classed("zebra", function(d,i) { return i % 2 == 0;})
      .on("mouseover", function(d) {
        d3.select("#detail-type").html("<span class='eco-basic-icon " + d.properties.observation_type + "'></span> Observation")
        ECO.detailview(d.properties);
      })
      .on("mouseout", function() {
        showLoadingView();
      })
      .each(function(d) {
        var entry = d3.select(this)
          .selectAll("td")
          .data(fields)
          .enter().append("td")

        entry.append("span")
          .attr("class", "value")
          .html(function(key) {
            var props = d.properties;
            if (typeof props[key] == "string") {
              if (props[key].slice(0,4) == "http") {
                return "<a href='" + props[key] + "'>" + props[key] + "</a>";
              }
              if (key == "record") {
                if (props["remote_resource"] !== "") {
                  return "<a href='" + props["remote_resource"] + "'>" + props[key] + "</a>";
                }
                return props[key]
              }
              if (key == "begin_date") {
                return dateformat(new Date(props[key]));
              }
              if (key == "end_date") {
                return dateformat(new Date(props[key]));
              }
              if (key == "observation_type") {
                return "<span class='eco-basic-icon " + props[key].replace(/ /g,"-") + "'></span>" + props[key];
              }
              return props[key]
            }
            if (key == "geojson") {
              return !!d.geometry ? "Yes" : "";
            }
            return JSON.stringify(props[key]);
          });
      });
  }

  return __;
};


var fieldlist = new ECO.list();
var datatable = new ECO.datatable();
var map = new ECO.map().subscribe(datatable.mapEvents);
var timebrush = d3.svg.brush()

d3.select("#export-reserves")
  .attr("href", ECO.base.api.reserves)
  .text(ECO.base.api.reserves);

d3.select("#loading-view .reserves")
  .classed("loaded", false)
  .text("Loading...");
d3.json(ECO.base.api.reserves, function(error, data) {
  d3.select("#loading-view .reserves")
    .classed("loaded", true)
    .text("Loaded");
  if (!data) return;
  data.results.forEach(function(d) {
    d3.select("#reserve-list")
      .append("option")
      .attr("value", JSON.stringify(d.geometry))
      .text(d.properties.name)
    map.addPoly(d, "#fb5");
  });
  d3.select("#reserve-list")
    .on("change", function() {
      queryObj.advanced["g"] = this.value;
    });
});

d3.select("#export-jepson")
  .attr("href", ECO.base.api.jepson)
  .text(ECO.base.api.jepson);

d3.select("#loading-view .jepson")
  .classed("loaded", false)
  .text("Loading...");
d3.json(ECO.base.api.jepson, function(error, data) {
  d3.select("#loading-view .jepson")
    .classed("loaded", true)
    .text("Loaded");
  if (!data) return;
  data.results.forEach(function(d) {
    d3.select("#jepson-list")
      .append("option")
      .attr("value", JSON.stringify(d.geometry))
      .text(d.properties.name);
  });
  d3.select("#reserve-list")
    .on("change", function() {
      queryObj.advanced["g"] = this.value;
    });
});

// filter by bounding box
d3.select("#bbox-select")
  .on("click", function() {
    var bds = map.map.getBounds();
    var bbox = [bds._northEast.lng, bds._northEast.lat, bds._southWest.lng, bds._southWest.lat].join(",");
    queryObj.bbox = bbox;
    query();
  });

// text boxes
d3.selectAll(".eco-param")
  .on("change", function() {
    queryObj.q = d3.select("#searchterm").node().value;
    queryObj.min_date = d3.select("#minyear").node().value;
    queryObj.max_date = d3.select("#maxyear").node().value;
    timebrush.extent([new Date(queryObj.min_date), new Date(queryObj.max_date)]);
    d3.select("#time-slider .brush").call(timebrush)

    queryObj.page = 1;
    query();
  });


// time slider
(function() {
  var margin = {top: 2, right: 14, bottom: 26, left: 14};
  var height = 1;
  var width = 250;

  queryObj.min_date = d3.select("#minyear").node().value;
  queryObj.max_date = d3.select("#maxyear").node().value;

  var x = d3.time.scale()
    .range([0, width])
    .domain([new Date("Jan 1 1900"), new Date()]).nice();
//    .domain([new Date(minyear), new Date(maxyear)]).nice();

  var xAxis = d3.svg.axis().scale(x).orient("bottom");
  timebrush.x(x)
      .on("brush", brushed)
      .on("brushend", brushend)

  if (queryObj.min_date.length > 0 && queryObj.max_date.length >0){
    timebrush.extent([new Date(queryObj.min_date),new Date(queryObj.max_date)]);
  }

  var context = d3.select("#time-slider")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("class", "context")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  context.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  context.append("g")
      .attr("class", "x brush")
      .call(timebrush)
    .selectAll("rect")
      .attr("y", -6)
      .attr("height", height + margin.bottom);


  function brushed() {
    var extent = timebrush.extent();

    queryObj.min_date = d3.select("#minyear").node().value = compactdateformat(extent[0]);
    queryObj.max_date = d3.select("#maxyear").node().value = compactdateformat(extent[1]);
  }

  function brushend() {
    var extent = timebrush.extent();
    if (compactdateformat(extent[0]) == compactdateformat(extent[1])) {
      // reset brushes
      d3.select("#minyear").node().value = "";
      d3.select("#maxyear").node().value = "";
    }
    query();
  }

})();

query();

function showLoadingView() {
  d3.select("#loading-view").style("display", null);
  d3.select("#detail-view").style("display", "none");
};

function query() {
  showLoadingView();
  d3.select("#results").style("color", "#bbb");

  var facetlist = d3.entries(queryObj.facets)
    .filter(function(d) { return d.value; });
  var facetstring = facetlist.map(function(d) {
    return "&selected_facets=" + d.key + "_exact%3A%22" + d.value + "%22";
  }).join("&");

  var sortlist = d3.entries(queryObj.sortFields)
    .filter(function(d) { return d.value; });
  var sortstring = sortlist.map(function(d) {
    return (d.value == "-" ? "-" : "") + d.key;
  }).join(",");

  var orderString = "";
  if (sortstring.length > 0) {
    orderString += "&ordering=" + sortstring;
  }

  var bboxString = "";
  if (queryObj.bbox) {
    bboxString = "&bbox=" + queryObj.bbox;
  }

  var advancedString = "";
  for (var key in queryObj.advanced) {
    advancedString += ",";
    advancedString += key;
    advancedString += ':"';
    advancedString += queryObj.advanced[key];
    advancedString += '"';
  }
  console.log(advancedString);

  var dateString = "";
  if (queryObj.min_date) {
    dateString += "&min_date=" + queryObj.min_date;
  }
  if (queryObj.max_date) {
    dateString += "&max_date=" + queryObj.max_date;
  }

  var qString = "";
  var qStringSimple = "";
  if (queryObj.q.length > 0 || advancedString.length > 0) {
    qString += '&q="' + queryObj.q + '"' + advancedString;
    qStringSimple += "&q=" + queryObj.q;
  }

  var hashString = orderString + facetstring + qString + bboxString + dateString + "&page_size=" + queryObj.page_size + "&page=" + queryObj.page;

  window.location.hash = hashString;

  var querystring = ECO.base.api.observations + "?format=geojson" + hashString;
  var searchquerystring = ECO.base.api.search + "?format=json" + orderString + facetstring+ qString + dateString + "&facets_limit=100";
  var photoquerystring = ECO.base.api.photos  + "?format=geojson" + orderString+ qStringSimple + bboxString + dateString + "&page_size=20page=1";

  console.log(querystring);

  // export links
  d3.select("#export-csv")
    .attr("href", ECO.base.api.observations + "?format=csv" + orderString + sortstring + facetstring + qString + bboxString + dateString + "&page_size=" + queryObj.page_size + "&page=" + queryObj.page)
    .text(ECO.base.api.observations + "?format=csv" + orderString + sortstring + facetstring + qString + bboxString + dateString + "&page_size=" + queryObj.page_size + "&page=" + queryObj.page);
  d3.select("#export-json")
    .attr("href", ECO.base.api.observations + "?format=json" + orderString + sortstring + facetstring + qString + bboxString + dateString + "&page_size=" + queryObj.page_size + "&page=" + queryObj.page)
    .text( ECO.base.api.observations + "?format=json" + orderString + sortstring + facetstring + qString + bboxString + dateString + "&page_size=" + queryObj.page_size + "&page=" + queryObj.page);
  d3.select("#export-geojson")
    .attr("href", ECO.base.api.observations + "?format=geojson" + orderString + sortstring + facetstring + qString + bboxString + dateString + "&page_size=" + queryObj.page_size + "&page=" + queryObj.page)
    .text(ECO.base.api.observations + "?format=geojson" + orderString + sortstring + facetstring + qString + bboxString + dateString + "&page_size=" + queryObj.page_size + "&page=" + queryObj.page);

  d3.select("#loading-view .observations")
    .classed("loaded", false)
    .text("Loading...");
  d3.json(querystring, function(error, data) {
    d3.select("#results").html("").style("color", null);
    d3.select("#loading-view .observations")
      .classed("loaded", true)
      .text("Loaded");

    if (error) {
      d3.select("#results").append("div").html(error.responseText).style("color", "red");
      return;
    }

    // Paging
    var startitem = queryObj.page_size*(queryObj.page-1);
    var enditem = Math.min(queryObj.page_size*(queryObj.page),data.count);
    var pagination = d3.select("#results").append("p")
      .attr("class", "paging");

    pagination.append("span").text("Results " + (startitem+1) + " to " + enditem + " of " + data.count + " - ");

    var pagecount = Math.ceil(data.count/queryObj.page_size);
    pagination.append("span")
      .attr("class", "pagination")
      .selectAll("span")
      .data(d3.range(1, pagecount+1).slice(0,20))
      .enter().append("span")
      .classed("active", function(d) { return d == queryObj.page;})
      .text(String)
      .on("click", function(d) {
        if (d == queryObj.page) return;
        queryObj.page = d;
        query();
      });

    // TEMPORARY warning of high page counts
    if (pagecount > 20) {
      d3.select("#results .pagination").append("em")
        .text("(more data available)");
    }

    var pagesize = pagination.append("p")
      .append("div")
      .attr("class", "pagination")
      .text("Page size ");

    pagesize.selectAll(".page-size")
      .data([20,50,100,500,1000,2000])
      .enter().append("span")
      .text(String)
      .attr("class", "page-size")
      .classed("active", function(d) { return d == queryObj.page_size; })
      .on("click", function(d) {
        queryObj.page_size = d;
        d3.selectAll(".page-size").classed("active", function(d) { return d == queryObj.page_size; })
        query();
      });

    d3.select(".pagination").append("div")
      .style("clear", "both");

    datatable.draw(data);

    mapData = dataFilterCoordinates(data || []);
    map.clear();
    map.draw();

    /*
    d3.range(2,Math.min(10,pagecount)).forEach(function(nextpage) {
      var nextquerystring = ECO.base.api.observations + "?ordering=" + sortstring + facetstring + "&format=geojson&q=" + queryObj.q + "&min_date=" + minyear + "&max_date=" + maxyear + "&page_size=" + queryObj.page_size + "&page=" + nextpage;
      d3.json(nextquerystring, function(error, data) {
      console.log(data);
        mapData.concat(dataFilterCoordinates(data || []));
        map.draw(mapData);
      });
    });
    */

  });


  d3.selectAll(".field-plot a").style("color", "#bbb");
  d3.select("#export-search")
    .attr("href", searchquerystring)
    .text(searchquerystring);

  d3.select("#loading-view .search")
    .classed("loaded", false)
    .text("Loading...");
  d3.json(searchquerystring, function(error, data) {
    d3.select("#loading-view .search")
      .classed("loaded", true)
      .text("Loaded");
    fieldlist.draw(data);
  });

  d3.select("#export-photos")
    .attr("href", photoquerystring)
    .text(photoquerystring);
  d3.select("#loading-view .photos")
    .classed("loaded", false)
    .text("Loading...");
  d3.json(photoquerystring, function(error, data) {
    d3.select("#loading-view .photos")
      .classed("loaded", true)
      .text("Loaded");
    photoData = dataFilterCoordinates(data || []);

    map.draw();

    var photos = d3.select("#photos .inner-photos")
      .html("")
      .selectAll("a")
      .data(data.features)
      .enter().append("a")
      .attr("href", function(d) { return d.properties.url; })
      .on("mouseover", function(d) {
        d3.select("#detail-type").text("Photo");
        ECO.detailview(d.properties);
      })
      .on("mouseout", function() {
        showLoadingView();
      });

    photos.append("img")
      .attr("src", function(d) { return d.properties.media_url; });

    if (data.next) {
      d3.select("#photos .inner-photos").append("span")
        .text(" Load more [+]")
        .datum(data.next)
        .on("click", loadMorePhotos);
    }

    function loadMorePhotos(url) {
      d3.select(this).remove();

      d3.select("#loading-view .photos")
        .classed("loaded", false)
        .text("Loading...");

      d3.select("#loading-view").style("display", null);
      d3.select("#detail-view").style("display", "none");
      d3.json(url, function(error, data) {
        d3.select("#loading-view .photos")
          .classed("loaded", true)
          .text("Loaded");
        photoData.concat(dataFilterCoordinates(data || []));
        map.draw();

        var existingPhotos = d3.select("#photos .inner-photos").selectAll("a").data();

        var photos = d3.select("#photos .inner-photos")
          .selectAll("a")
          .data(existingPhotos.concat(data.features))
          .enter().append("a")
          .attr("href", function(d) { return d.properties.url; })
          .on("mouseover", function(d) {
            d3.select("#detail-type").text("Photo");
            ECO.detailview(d.properties);
          })
          .on("mouseout", function() {
            showLoadingView();
          });

        photos.append("img")
          .attr("src", function(d) { return d.properties.media_url; });


        if (data.next) {
          d3.select("#photos .inner-photos").append("span")
            .text("Load more [+]")
            .datum(data.next)
            .on("click", loadMorePhotos);
        }
      });
    };
  });
};

function capitaliseFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
};

function dataFilterCoordinates(data) {
  if (!data || !data.hasOwnProperty('features')) return [];
  if (!data.features.length) return [];

  return data.features.filter(function(d){
    return d.geometry && d.geometry.coordinates.length === 2;
  });
}
</script>
