<!DOCTYPE html>
<meta charset="utf-8">
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
  font-family: "Lato", "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 13px;
  width: 100%;
  background: #f6f6f6;
  margin: 0;
}

a {
  color: #317eac;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

.wrap {
  margin: 8px;
}

/* Time Slider */
svg {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

#time-slider {
  display: inline;
}

#time-slider svg {
  margin-bottom: -12px;
}

.pagination {
  width: 100%;
}

.pagination span {
  margin-right: 7px;
  float: left;
  cursor: pointer;
  padding: 1px 3px;
  color: #317eac;
}
.pagination span:hover {
  text-decoration: underline;
}
.pagination span.active {
  background: #317eac;
  color: #fff;
  border-radius: 3px;
  padding: 1px 6px;
  cursor: default;
}

.panel {
  position: relative;
  display: inline-block;
  margin: 0 1% 0 0;
  padding: 0;
  vertical-align: top;
}
.panel.left {
  width: 30%;
}
.panel.right {
  width: 68%;
}
.panel:last-child {
  margin-right: 0;
}

/* MAP */
#map {
  width: 100%;
  height: 320px;
}

.map-info {
  position: absolute;
  display: none;
  top: 0;
  right: 0;
  width: 90%;
  height: auto;
  background: #fff;
  background: rgba(255,255,255,0.8);
  z-index: 1001;
}
.map-info.visible {
  display: block;
}

.map-info-close {
  position: absolute;
  top: 1px;
  right: 5px;
  padding: 0;
  background: transparent;
  border: none;
  outline: none;
  font-weight: normal;
  font-size: 10px;
  text-transform: uppercase;
  color: #aaa;
  cursor: pointer;
}

.map-info-content {
  padding: 10px 30px 10px 10px;
  margin: 0;
  font-size: 12px;
  line-height: 18px;
  color: #333;
}

#results table {
  font-size: 12px;
}

#results table td,
#results table th {
  padding: 2px 4px;
}
#results table th {
  border-bottom: 2px solid #e6e6e6;
}
.listing {
  border-bottom: 1px solid #e6e6e6;
}
.zebra {
  background: #fff;
}

a:hover .bar {
  background: #ee4e32;
}
.field-plot {
  line-height: 14px;
}
.field-plot a {
  text-decoration: none;
}
.field-plot a {
  color: #222;
}
.field-plot a.active {
  font-weight: bold;
}
.field-plot .x {
  display: none;
  color: #ee4e32;
  font-weight: bold;
}
.field-plot a.active:hover .x {
  display: inline;
} 
.bar {
  display: inline-block;
  margin: 0 8px -1px;
  background: #317eac;
}
h3 {
  font-size: 1em;
  line-height: 1em;
  margin: 10px 0 4px 0;
}
</style>
<body>
<div class="wrap">
  <p>
    Search Term: <input type="text" value="rufus" id="searchterm" class="eco-param"></input>
    Date Range: <input type="text" value="1920" id="minyear" class="eco-param"></input>
    <span id="time-slider"></span>
    <input type="text" value="1975" id="maxyear" class="eco-param"></input>
    <br/>
    Export <a href="#" id="export-csv" target="_blank">CSV</a> |
    <a href="#" id="export-json" target="_blank">JSON</a> |
    <a href="#" id="export-geojson" target="_blank">GeoJSON</a>
  </p>
  <div class="panel left">
    <div id="search-bars"></div>
  </div>
  <div class="panel right">
    <div id="map"></div>
    <div class="map-info">
        <button class="map-info-close">x</button>
        <p class="map-info-content"></p>
    </div>
    <div id="results"></div>
  </div>
</div>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
var limit = 100;
var page = 1;
var facets = {
  kingdom: false,
  phylum: false,
  clss: false,
  order: false,
  family: false,
  genus: false,
  'scientific_name': false,
  'state_province': false,
  resource: false
};

var fields = [
  "record",
  "scientific_name",
  "country",
  "state_province",
  "begin_date",
  "end_date",
  "geojson",
  "observation_type"
];

var ECO = {};
ECO.base = {
  api: {
    search: 'https://dev-ecoengine.berkeley.edu/api/search/',
    observations: 'https://dev-ecoengine.berkeley.edu/api/observations/',
    tiles: 'https://dev-ecoengine.berkeley.edu/tiles/vtmveg/{z}/{x}/{y}.png'
  }
}

var sortOrder = {
  kingdom: 0,
  phylum: 1,
  clss: 2,
  order: 3,
  family: 4,
  genus: 5,
  'scientific_name': 6,
  'state_province': 7,
  resource: 8
};

var dateformat = d3.time.format("%Y %b %e");

ECO.map = function() {
  var __ = {};

  var defaultCenter = new L.LatLng(37.7,-122),
      defaultZoom = 6,
      markers = [],
      map;

  var myIcon = L.divIcon({
    className: 'eco-basic-icon',
    iconSize: new L.Point(10,10)
  });

  var popup = L.popup({
    closeButton: false
  });

  map = __.map = L.map('map').setView(defaultCenter, defaultZoom);

  var baseLayer = L.tileLayer(ECO.base.api.tiles, {
    attribution: '&copy; <a href="http://ecoengine.berkeley.edu">EcoEngine</a>',
    subdomains: 'abc',
    minZoom: 1,
    maxZoom: 18
  }).addTo(map);

  function clearMarkers() {
    markers.forEach(function(marker){
      marker.on('mouseover', null)
            .on('mouseout', null);
      map.removeLayer(marker);
      marker = undefined;
    });

    markers.length = 0;
  }

  function addMarkers(data) {
    var bds = null;

    data.forEach(function(d){
      var ll = new L.LatLng(d.geometry.coordinates[1], d.geometry.coordinates[0])
      var m = L.marker(ll, {icon: myIcon}).addTo(map);
      m.data_ = d.properties;
      m.on('mouseover', showTooltip)
        .on('mouseout', hideTooltip);

      if (!bds) {
        bds = new L.latLngBounds([ll]);
      } else {
        bds.extend(ll);
      }
      markers.push(m);
    });
    bds.pad(0.1);
    map.fitBounds(bds);
  }

  function showTooltip() {
      if (!this.data_) return;
      popup
          .setLatLng(this._latlng)
          .setContent(this.data_['scientific_name'] || 'n/a')
          .openOn(map);
  }

  function hideTooltip() {
      popup._close();
  }

  function dataFilterCoordinates(data) {

    if (!data || !data.hasOwnProperty('features')) return [];
    if (!data.features.length) return [];

    return data.features.filter(function(d){
      return d.geometry.coordinates.length === 2;
    });
  }

  __.onData = function(data){
    clearMarkers();

    data = dataFilterCoordinates(data.mapdata || []);
    if (!data.length) {
      ECO.mapAlert.set('No map data available.');
      return;
    }

    ECO.mapAlert.hide();
    addMarkers(data);
  }

  return __;
};

ECO.list = function() {
  var __ = {};

  var barwidth = d3.scale.linear()
    .range([0, 100]);

  __.draw = function(data) {
    d3.selectAll(".field-plot a").style("color", null);

    // Total bar width
    var maxcount = 0;
    for (var key in data.fields) {
      var count = 0;
      data.fields[key].forEach(function(d) {
        count += d[1];
      });
      if (count > maxcount) maxcount = count;
    }
    barwidth.domain([0, maxcount]);

    var searchfields = d3.keys(data.fields);
    searchfields.sort(function(a,b){
      return sortOrder[a] - sortOrder[b];
    });

    // Groups
    var fieldplot = d3.select("#search-bars")
      .html("")
      .selectAll("div.field-plot")
      .data(searchfields.map(function(key) { return {
        "field": key,
        "values": data.fields[key]
      }}))
      .enter().append("div")
      .attr("class", "field-plot");

    fieldplot.append("h3")
      .text(function(d) { return capitaliseFirstLetter(d.field.replace("_", " "))});

    var bars = fieldplot.selectAll("div.bars")
        .data(function(d) { return d.values; })
        .enter().append("div")
        .attr("class", "bars")
        .append("a")
        .attr("href", function(d) { return "#"; })
        .classed("active", function(d,i,g) {
          return facets[searchfields[g]] == d[0];
        })
        .on("click", function(d,i,g) {
          page = 1;
          if (facets[searchfields[g]] == d[0]) {
            facets[searchfields[g]] = false;
          } else {
            facets[searchfields[g]] = d[0];
          }
          query();
        });

    bars.append("div")
      .attr("class", "bar")
      .style("height", "12px")
      .style("width", function(d) { return Math.round(barwidth(d[1])) + "px"; });

    bars.append("span")
      .attr("class", "count")
      .text(function(d) { return d[1]; });

    bars.append("span")
      .text(function(d) { return " " + capitaliseFirstLetter(d[0]); });

    bars.append("span")
      .attr("class", "x")
      .text(" x");
  }
  return __;
};

ECO.datatable = function() {
  var __ = {};

  __.draw = function(data) {
    var table = d3.select("#results")
      .append("table")
      .attr("class", "table");

    table.append("tr")
      .selectAll("th")
      .data(fields)
      .enter().append("th")
      .text(String);

    table
      .selectAll("tr.listing")
      .data(data.results)
      .enter().append("tr")
      .attr("class", "listing")
      .classed("zebra", function(d,i) { return i % 2 == 0;})
      .each(function(d) {
        var entry = d3.select(this)
          .selectAll("td")
          .data(fields)
          .enter().append("td")

        entry.append("span")
          .attr("class", "value")
          .html(function(key) {
            if (typeof d[key] == "string") {
              if (d[key].slice(0,4) == "http") {
                return "<a href='" + d[key] + "'>" + d[key] + "</a>";
              }
              if (key == "record") {
                return "<a href='" + d["url"] + "'>" + d[key] + "</a>";
              }
              if (key == "begin_date") {
                return dateformat(new Date(d[key]));
              }
              if (key == "end_date") {
                return dateformat(new Date(d[key]));
              }
              return d[key]
            }
            if (key == "geojson") {
              return !!d[key] ? "Yes" : "";
            }
            return JSON.stringify(d[key]);
          });
      });
  }

  return __;
};


query();

// text boxes
d3.selectAll(".eco-param")
  .on("change", function() {
    page = 1;
    query();
  });


// time slider
(function() {
  var margin = {top: 2, right: 14, bottom: 24, left: 14};
  var height = 1;
  var width = 350;

  var minyear = d3.select("#minyear").node().value;
  var maxyear = d3.select("#maxyear").node().value;

  var x = d3.time.scale()
    .range([0, width])
    .domain([new Date("1900"), new Date()]).nice();
//    .domain([new Date(minyear), new Date(maxyear)]).nice();

  var xAxis = d3.svg.axis().scale(x).orient("bottom");
  var brush = d3.svg.brush()
      .x(x)
      .on("brush", brushed)
      .on("brushend", query);

  var context = d3.select("#time-slider")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("class", "context")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  context.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  context.append("g")
      .attr("class", "x brush")
      .call(brush)
    .selectAll("rect")
      .attr("y", -6)
      .attr("height", height + margin.bottom);

  function brushed() {
    var extent = brush.extent();
    d3.select("#minyear").attr("value", extent[0].getFullYear());
    d3.select("#maxyear").attr("value", extent[1].getFullYear());
  }
})();

var fieldlist = new ECO.list();
var datatable = new ECO.datatable();
var map = new ECO.map();

function query() {
  d3.select("#results").style("color", "#bbb");
  var term = d3.select("#searchterm").node().value;
  var minyear = d3.select("#minyear").node().value;
  var maxyear = d3.select("#maxyear").node().value;

  var facetlist = d3.entries(facets)
    .filter(function(d) { return d.value; })
  var facetstring = facetlist.map(function(d) {
    return "&selected_facets=" + d.key + "_exact%3A%22" + d.value + "%22";
  }).join("&");

  var querystring = ECO.base.api.observations + "?extra=record" + facetstring + "&format=json&q=" + term + "&min_date=" + minyear + "&max_date=" + maxyear + "&page_size=" + limit + "&page=" + page;
  var searchquerystring = ECO.base.api.search + "?extra=record" + facetstring + "&format=json&q=" + term + "&min_date=" + minyear + "&max_date=" + maxyear;
  console.log(searchquerystring);

  // export links
  d3.select("#export-csv")
    .attr("href", ECO.base.api.observations + "?extra=record&format=csv&q=" + term + "&min_date=" + minyear + "&max_date=" + maxyear + "&page_size=" + limit + "&page=" + page);
  d3.select("#export-json")
    .attr("href", ECO.base.api.observations + "?extra=record&format=json&q=" + term + "&min_date=" + minyear + "&max_date=" + maxyear + "&page_size=" + limit + "&page=" + page);
  d3.select("#export-geojson")
    .attr("href", ECO.base.api.observations + "?extra=record&format=geojson&q=" + term + "&min_date=" + minyear + "&max_date=" + maxyear + "&page_size=" + limit + "&page=" + page);

  d3.json(querystring, function(error, data) {
    d3.select("#results").html("").style("color", null);

    d3.select("#results")
      .append("p")
      .html("<strong>Query:</strong> " + querystring);

    if (error) {
      d3.select("#results").append("div").html(error.responseText).style("color", "red");
      return;
    }
    console.log(data);

    // Display total number of results
    var countdiv = d3.select("#results p").append("div");
    countdiv.append("strong").text("Results: ");
    countdiv.append("span").text(data.count);

    // Paging
    var pagecount = Math.ceil(data.count/limit);
    d3.select("#results").append("p")
      .attr("class", "pagination")
      .selectAll("span")
      .data(d3.range(1, pagecount+1))
      .enter().append("span")
      .classed("active", function(d) { return d == page;})
      .text(String)
      .on("click", function(d) {
        if (d == page) return;
        page = d;
        query();
      });

    d3.select(".pagination").append("div")
      .style("clear", "both");

    var startitem = limit*(page-1);
    var enditem = Math.min(limit*(page),data.count);
    d3.select("#results").append("p").text("Results " + (startitem+1) + " to " + enditem);

    datatable.draw(data);
    //map.draw(data);
  });


  d3.selectAll(".field-plot a").style("color", "#bbb");
  d3.json(searchquerystring, function(error, data) {
    fieldlist.draw(data);
  });

};

function capitaliseFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
};
</script>
