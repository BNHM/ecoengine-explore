<!DOCTYPE html>
<html>
<head>
<style>
body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  width: 780px;
  margin: 30px auto;
  color: #222;
  font-size: 15px;
  text-align: center;
}
#controls {
  line-height: 1.8em;
}
</style>
<title>Raster layer picker</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
</head>
<body>

<h2>Raster Layer Picker</h2>
<p id="controls">
  Variable: <select id="metric-picker"></select>
  Scenario: <select id="model-picker"></select><br/>
  Raster: <select id="raster-picker"></select>
</p>
<div id="map" style="width: 780px; height: 400px"></div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script>

  var map = L.map('map')
    .setView([37.733795, -97.446747], 4);

  var activeLayer = L.tileLayer('', {
    maxZoom: 18,
    attribution: ''
  });

  d3.json("slugs.json", function(error, slugs) {
    console.log(slugs);
    var nex_datasets = slugs.metrics.filter(function(d) {
      return "nex" in d && !!d["nex"];     // is this a NASA NEX raster?
    });

    // metric picker 
    d3.select("#metric-picker")
      .on("change", function() {
        populateRasterPicker();
      })
      .selectAll("option")
      .data(nex_datasets)
      .enter().append("option")
      .attr("value", function(d) { return d.slug; })
      .text(function(d) { return d.name; });

    // metric picker 
    d3.select("#model-picker")
      .on("change", function() {
        populateRasterPicker();
      })
      .selectAll("option")
      .data(slugs.models)
      .enter().append("option")
      .attr("value", function(d) { return d.slug; })
      .text(function(d) { return d.name; });

    // raster picker
    d3.select("#raster-picker")
      .on("change", function() {
        if (this.value == "Select raster layer") return;
        map.removeLayer(activeLayer);
        activeLayer = L.tileLayer(this.value);
        map.addLayer(activeLayer);
      });

    populateRasterPicker();

    function populateRasterPicker() {
      var slug = d3.select("#metric-picker").node().value + "_" + d3.select("#model-picker").node().value;
      d3.json("https://ecoengine.berkeley.edu/api/series/" + slug + "/rasters/?page_size=1000", function(error, resp) {
        d3.select("#raster-picker")
          .html("")

        d3.select("#raster-picker")
          .append("option")
          .text("Select raster layer")

        d3.select("#raster-picker")
          .selectAll("option.raster-option")
          .data(resp.results)
          .enter().append("option")
          .attr("class", "raster-option")
          .attr("value", function(d) { return d.tile_template; })
          .text(function(d) { return d.event; });

        d3.select("#raster-picker")
          .style("opacity", 0)
          .transition()
          .duration(600)
          .style("opacity", 1);
      });
    };
  });
</script>
